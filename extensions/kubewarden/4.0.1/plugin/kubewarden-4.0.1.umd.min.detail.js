(("undefined"!==typeof self?self:this)["webpackChunkkubewarden_4_0_1"]=("undefined"!==typeof self?self:this)["webpackChunkkubewarden_4_0_1"]||[]).push([[332],{9551:function(e,t,r){var o={"./kubewarden-dashboard-policy.json":[18938,521],"./kubewarden-dashboard-policyserver.json":[65682,712]};function a(e){if(!r.o(o,e))return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=o[e],a=t[0];return r.e(t[1]).then((function(){return r.t(a,19)}))}a.keys=function(){return Object.keys(o)},a.id=9551,e.exports=a},12358:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return d}});var o=r(9274);function a(e,t,r,a,n,i){const s=(0,o.resolveComponent)("PolicyDetail");return(0,o.openBlock)(),(0,o.createBlock)(s,{value:r.value,mode:r.mode,resource:n.resource},null,8,["value","mode","resource"])}var n=r(14220),i=r(56505),s=r(98618),l={name:"ClusterAdmissionPolicy",props:{mode:{type:String,default:n.YQ},value:{type:Object,required:!0}},components:{PolicyDetail:s.A},data(){return{resource:i.$v.ADMISSION_POLICY}}},c=r(47433);const p=(0,c.A)(l,[["render",a]]);var d=p},13914:function(e,t,r){"use strict";r.r(t);var o=r(36758),a=r.n(o),n=r(40935),i=r.n(n),s=i()(a());s.push([e.id,".relative[data-v-71bb3388]{position:relative}.policy__mode[data-v-71bb3388]{display:flex;align-items:center}.policy__mode i[data-v-71bb3388]{margin-left:5px;font-size:22px;color:var(--warning)}.gauges[data-v-71bb3388],.gaugesContainer[data-v-71bb3388]{display:flex}.gauges[data-v-71bb3388]{justify-content:space-around;flex-wrap:wrap;justify-content:left}.gauges .count-gauge[data-v-71bb3388]{width:46%;margin-bottom:10px;flex:initial}.gauges[data-v-71bb3388]>*{flex:1;margin-right:1.75%}",""]),t["default"]=s},16e3:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return M}});var o=r(9274);const a={key:1},n={key:0,class:"row"},i={class:"col span-6"},s={"data-testid":"kw-ps-detail-status-title"},l={class:"gauges mb-20"},c={key:0,class:"col span-6"},p={class:"gauges mb-20"};function d(e,t,r,d,u,m){const h=(0,o.resolveComponent)("Loading"),b=(0,o.resolveComponent)("CountGauge"),y=(0,o.resolveComponent)("BadgeState"),v=(0,o.resolveComponent)("ResourceTable"),g=(0,o.resolveComponent)("Tab"),k=(0,o.resolveComponent)("TraceTable"),f=(0,o.resolveComponent)("MetricsTab"),w=(0,o.resolveComponent)("ResourceTabs");return e.$fetchState.pending?((0,o.openBlock)(),(0,o.createBlock)(h,{key:0})):((0,o.openBlock)(),(0,o.createElementBlock)("div",a,[u.policyGauges?((0,o.openBlock)(),(0,o.createElementBlock)("div",n,[(0,o.createElementVNode)("template",null,[(0,o.createElementVNode)("div",i,[(0,o.createElementVNode)("h3",s,(0,o.toDisplayString)(e.t("kubewarden.policyServer.policyGauge.byStatus")),1),(0,o.createElementVNode)("div",l,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(u.policyGauges,((e,t)=>((0,o.openBlock)(),(0,o.createBlock)(b,{key:t,total:m.relatedPoliciesTotal,useful:e.count||0,graphical:!1,"primary-color-var":`--sizzle-${e.color}`,name:t},null,8,["total","useful","primary-color-var","name"])))),128))])])]),m.emptyTraces?(0,o.createCommentVNode)("",!0):((0,o.openBlock)(),(0,o.createElementBlock)("div",c,[(0,o.createElementVNode)("h3",null,(0,o.toDisplayString)(e.t("kubewarden.policyServer.policyGauge.traces")),1),(0,o.createElementVNode)("div",p,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(m.tracesGauges,((e,t)=>((0,o.openBlock)(),(0,o.createBlock)(b,{key:t,useful:e.count||0,total:m.traceGaugeTotals,graphical:!1,"primary-color-var":`--sizzle-${e.color}`,name:t},null,8,["useful","total","primary-color-var","name"])))),128))])]))])):(0,o.createCommentVNode)("",!0),(0,o.createVNode)(w,{value:r.value,mode:r.mode},{default:(0,o.withCtx)((()=>[(0,o.createVNode)(g,{name:"related-policies",label:"Policies",weight:99},{default:(0,o.withCtx)((()=>[(0,o.createVNode)(v,{rows:u.relatedPolicies||[],headers:u.RELATED_HEADERS,groupable:!0,"group-by":m.groupPreference,"table-actions":!0,"use-query-params-for-simple-filtering":!0,"data-testid":"kw-ps-detail-related-policies-list"},{"col:operation":(0,o.withCtx)((({row:t})=>[(0,o.createElementVNode)("td",null,[(0,o.createVNode)(y,{"data-testid":`kw-ps-detail-${t.id}-state`,label:t.operation,color:e.color(t.operation)},null,8,["data-testid","label","color"])])])),_:1},8,["rows","headers","group-by"])])),_:1}),(0,o.createVNode)(g,{name:"policy-tracing",label:"Tracing",weight:98,class:"relative"},{default:(0,o.withCtx)((()=>[(0,o.createVNode)(k,{resource:u.resource,"related-policies":u.relatedPolicies},null,8,["resource","related-policies"])])),_:1}),(0,o.createVNode)(g,{name:"policy-metrics",label:"Metrics",weight:97,class:"relative"},{default:(0,o.withCtx)((e=>[(0,o.createVNode)(f,{resource:u.resource,"policy-server-obj":r.value,active:e.active},null,8,["resource","policy-server-obj","active"])])),_:1})])),_:1},8,["value","mode"])]))}var u=r(65359),m=r(3514),h=r.n(m),b=r(14220),y=r(88339),v=r(91825),g=r(91462),k=r(87102),f=r(777),w=r(84409),S=r(6603),C=r(31400),E=r(49584),A=r(65165),N=r(56505),R=r(30669),T=r(96003),V={name:"PolicyServer",components:{BadgeState:k.j,CountGauge:f.A,Loading:w.A,MetricsTab:R.A,ResourceTabs:S.A,ResourceTable:C.A,Tab:E.A,TraceTable:T.A},mixins:[v.A],props:{mode:{type:String,default:b.YQ},value:{type:Object,required:!0}},async fetch(){const e=await(0,y.kR)({relatedPolicies:this.value.allRelatedPolicies(),policyGauges:this.value.policyGauges()}),t=(e,t)=>{h()(t)||(this[e]=t)};t("relatedPolicies",e.relatedPolicies),t("policyGauges",e.policyGauges)},data(){return{RELATED_HEADERS:A.DD,policyGauges:null,relatedPolicies:null,reloadRequired:!1,resource:N.$v.POLICY_SERVER}},computed:{...(0,u.L8)(["currentCluster"]),...(0,u.L8)({policyTraces:"kubewarden/policyTraces"}),_group:(0,g.AN)(g.EI),filteredTraces(){return h()(this.policyTraces)?null:this.policyTraces.filter((e=>{if(this.currentCluster?.id===e.cluster)return e}))},emptyTraces(){return h()(this.filteredTraces)},groupPreference(){const e="namespace"===this._group?"kind":null;return e},relatedPoliciesTotal(){return h()(this.relatedPolicies)?0:this.relatedPolicies.length},tracesGauges(){return this.emptyTraces?null:this.value.tracesGauges(this.filteredTraces)},traceGaugeTotals(){return this.emptyTraces?0:this.filteredTraces?.flatMap((e=>e.traces)).length}},methods:{hasNamespaceSelector(e){return e.namespaceSelector}}},_=(r(91226),r(47433));const P=(0,_.A)(V,[["render",d],["__scopeId","data-v-71bb3388"]]);var M=P},17081:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return d}});var o=r(9274);function a(e,t,r,a,n,i){const s=(0,o.resolveComponent)("PolicyDetail");return(0,o.openBlock)(),(0,o.createBlock)(s,{value:r.value,mode:r.mode,resource:n.resource},null,8,["value","mode","resource"])}var n=r(14220),i=r(56505),s=r(98618),l={name:"AdmissionPolicy",props:{mode:{type:String,default:n.YQ},value:{type:Object,required:!0}},components:{PolicyDetail:s.A},data(){return{resource:i.$v.ADMISSION_POLICY}}},c=r(47433);const p=(0,c.A)(l,[["render",a]]);var d=p},30669:function(e,t,r){"use strict";r.d(t,{A:function(){return de}});var o=r(9274);const a={key:1};function n(e,t,r,n,i,s){const l=(0,o.resolveComponent)("Loading"),c=(0,o.resolveComponent)("Banner"),p=(0,o.resolveComponent)("MetricsChecklist"),d=(0,o.resolveComponent)("DashboardMetrics");return e.$fetchState.pending?((0,o.openBlock)(),(0,o.createBlock)(l,{key:0,mode:"relative"})):((0,o.openBlock)(),(0,o.createElementBlock)("div",a,[s.hasAvailability?s.showChecklist?((0,o.openBlock)(),(0,o.createBlock)(p,{key:1,"cattle-dashboard-ns":s.cattleDashboardNs,"conflicting-grafana-dashboards":s.conflictingGrafanaDashboards,"controller-app":s.controllerApp,"controller-chart":s.controllerChart,"kubewarden-service-monitor":s.kubewardenServiceMonitor,"kubewarden-dashboards":s.kubewardenGrafanaDashboards,"metrics-configuration":s.metricsConfiguration,"monitoring-app":s.monitoringApp,"monitoring-chart":s.monitoringChart,"open-tel-svc":s.openTelSvc,"policy-obj":r.policyObj,"policy-server-obj":r.policyServerObj,"outdated-telemetry-spec":i.outdatedTelemetrySpec,"unsupported-telemetry-spec":i.unsupportedTelemetrySpec,"outdated-service-monitor":s.outdatedServiceMonitor,onUpdateServiceMonitors:s.updateServiceMonitors,onUpdateServiceMonitorLabels:s.updateServiceMonitorLabels},null,8,["cattle-dashboard-ns","conflicting-grafana-dashboards","controller-app","controller-chart","kubewarden-service-monitor","kubewarden-dashboards","metrics-configuration","monitoring-app","monitoring-chart","open-tel-svc","policy-obj","policy-server-obj","outdated-telemetry-spec","unsupported-telemetry-spec","outdated-service-monitor","onUpdateServiceMonitors","onUpdateServiceMonitorLabels"])):((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:2},[s.monitoringApp&&!i.metricsProxy?((0,o.openBlock)(),(0,o.createBlock)(c,{key:0,color:"error",label:e.t("kubewarden.monitoring.warning.noProxy")},null,8,["label"])):(0,o.createCommentVNode)("",!0),i.metricsProxy&&r.active?((0,o.openBlock)(),(0,o.createBlock)(d,{key:1,"data-testid":"kw-ps-metrics-dashboard","detail-url":i.metricsProxy,"summary-url":i.metricsProxy,vars:{policy_name:s.policyName},"graph-height":"825px"},null,8,["detail-url","summary-url","vars"])):(0,o.createCommentVNode)("",!0)],64)):((0,o.openBlock)(),(0,o.createBlock)(c,{key:0,color:"error",class:"mt-20 mb-20","data-testid":"kw-unavailability-banner",label:e.t("kubewarden.unavailability.banner",{type:e.t("kubewarden.unavailability.type.metricsDashboard")})},null,8,["label"]))]))}var i=r(65359),s=r(3514),l=r.n(s),c=r(12784),p=r.n(c),d=r(2722),u=r.n(d),m=r(35664),h=r(2841),b=r(97348),y=r(83416),v=r(88339),g=r(72586),k=r(83030),f=r(84409),w=r(9980),S=r(56505),C=r(65921),E=r(63875),A=r(67541);async function N(e){const{store:t,type:r}=e;try{const e=await R(t);if(!l()(e)){const t=`/api/v1/namespaces/${e.metadata.namespace}/services`,o=`/http:${e.metadata.name}:80/proxy`,a=`/d/${r}?orgId=1&kiosk`;return t+o+a}}catch(o){(0,E.q)({error:o,store:t,type:"warning"})}return null}async function R(e){try{return await e.dispatch("cluster/find",{type:m.YV,id:"cattle-monitoring-system/rancher-monitoring-grafana"},{root:!0})}catch(t){(0,E.q)({error:t,store:e,type:"warning"})}}async function T(e){try{return await e.dispatch("cluster/findMatching",{type:m.K5,selector:"kubewarden/part-of=cattle-kubewarden-system"})}catch(t){(0,E.q)({error:t,store:e,type:"warning"})}}async function V(e){const{store:t,monitoringApp:o,controllerApp:a}=e;if(o&&a){const e=Object.values(S.YR);for(const i of e){const e=await r(9551)(`./${i}.json`),s=`${i}.json`,l=await T(t);if(l&&l?.metadata?.name===i)return;const c={[S.kl.DASHBOARD]:i,[S.kl.PART_OF]:a.metadata.namespace,[S.kl.APP]:"rancher-monitoring-grafana",[S.kl.GRAFANA_DASHBOARD]:"1","app.kubernetes.io/instance":o.metadata.name},p={[S.tQ.NAME]:o.metadata.name,[S.tQ.NAMESPACE]:o.metadata.namespace},d=await t.dispatch("cluster/create",{type:m.K5,metadata:{annotations:p,labels:c,name:i,namespace:"cattle-dashboards"},data:{[s]:JSON.stringify(e)}});try{await d.save()}catch(n){(0,E.q)({error:n,store:t})}}}}var _=r(65560);function P(e){const{policyObj:t,policyServerObj:r,allServiceMonitors:o}=e;if(!l()(o)){const e=t?t.spec?.policyServer:r?.id;return o?.find((t=>{const r=t?.spec?.selector?.matchLabels;return(0,_.uw)(r,e)}))}}async function M(e){const{store:t,policyObj:r,controllerNs:o,serviceMonitor:a}=e;let{policyServerObj:n}=e;if(!a&&t.getters["cluster/schemaFor"](m.Rp.SERVICEMONITOR)){if(!n&&r&&t.getters["cluster/schemaFor"](S.$v.POLICY_SERVER)){const e=await t.dispatch("cluster/find",{type:S.$v.POLICY_SERVER,id:r.spec?.policyServer});e&&(n=e)}const e=r?r.spec?.policyServer:n?.id,a={"app.kubernetes.io/instance":`policy-server-${e}`,"app.kubernetes.io/component":"policy-server","app.kubernetes.io/part-of":"kubewarden"};let s;s=n?.metadata?.labels&&n?.metadata?.labels["app"]?{app:n?.metadata?.labels["app"]}:a;const l={apiVersion:"monitoring.coreos.com/v1",kind:"ServiceMonitor",type:m.Rp.SERVICEMONITOR,metadata:{name:`kubewarden-${e}`,namespace:o},spec:{endpoints:[{interval:"10s",port:"metrics"}],namespaceSelector:{matchNames:[o]},selector:{matchLabels:s}}},c=await t.dispatch("cluster/create",l);try{await c.save()}catch(i){(0,E.q)({error:i,store:t})}}}function O(e,t){if(!e||!t)return!1;const r=e.metadata?.labels||{},o=t.spec?.selector?.matchLabels||{},a={"app.kubernetes.io/component":"policy-server","app.kubernetes.io/part-of":"kubewarden"},n=r["app.kubernetes.io/instance"]&&r["app.kubernetes.io/component"]&&r["app.kubernetes.io/part-of"];if(n){const e=o["app.kubernetes.io/instance"]&&o["app.kubernetes.io/component"]===a["app.kubernetes.io/component"]&&o["app.kubernetes.io/part-of"]===a["app.kubernetes.io/part-of"];return!e}return!1}var B=r(74947);const D={class:"checklist__container"},j={class:"checklist__prereq mb-20"},x={class:"mt-20 mb-20"},L={class:"checklist__step mb-20","data-testid":"kw-monitoring-checklist-step-open-tel"},$={class:"checklist__step mb-20","data-testid":"kw-monitoring-checklist-step-monitoring-app"},I={class:"checklist__config"},q={p:""},Y=["disabled"],U={class:"checklist__step mb-20","data-testid":"kw-monitoring-checklist-step-service-monitor-map"},G={class:"checklist__config"},W={p:""},z={class:"checklist__config"},F={p:""},Q={class:"checklist__step mb-20","data-testid":"kw-monitoring-checklist-step-config-map"},K={class:"checklist__config"},H={p:""},J={"data-testid":"kw-monitoring-checklist-conflicting-banner",class:"conflicting-banner"},X={class:"checklist__step mb-20","data-testid":"kw-monitoring-checklist-step-controller-config"},Z={class:"checklist__config"},ee={p:""},te=["disabled"];function re(e,t,r,a,n,i){const s=(0,o.resolveComponent)("Banner"),l=(0,o.resolveComponent)("AsyncButton"),c=(0,o.resolveComponent)("router-link"),p=(0,o.resolveDirective)("clean-html"),d=(0,o.resolveDirective)("clean-tooltip");return(0,o.openBlock)(),(0,o.createElementBlock)("div",D,[(0,o.createElementVNode)("div",j,[(0,o.createElementVNode)("h2",null,(0,o.toDisplayString)(e.t("kubewarden.monitoring.prerequisites.label")),1),(0,o.createElementVNode)("p",null,(0,o.toDisplayString)(e.t("kubewarden.monitoring.prerequisites.description")),1)]),(0,o.createVNode)(s,{color:"warning",label:e.t("kubewarden.monitoring.prerequisites.warning")},null,8,["label"]),(0,o.createElementVNode)("div",x,[(0,o.createElementVNode)("div",L,[(0,o.createElementVNode)("i",{"data-testid":"kw-otel-icon",class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(r.openTelSvc)])},null,2),(0,o.withDirectives)((0,o.createElementVNode)("p",null,null,512),[[p,e.t("kubewarden.tracing.openTelemetry",{},!0)]])]),(0,o.createElementVNode)("div",$,[(0,o.createElementVNode)("i",{"data-testid":"kw-monitoring-icon",class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(r.monitoringApp)])},null,2),(0,o.createElementVNode)("div",I,[(0,o.withDirectives)((0,o.createElementVNode)("p",q,null,512),[[p,e.t("kubewarden.monitoring.prerequisites.monitoringApp.label",{},!0)]]),r.monitoringApp?(0,o.createCommentVNode)("",!0):(0,o.withDirectives)(((0,o.openBlock)(),(0,o.createElementBlock)("button",{key:0,"data-testid":"kw-monitoring-checklist-step-config-button",class:"btn role-primary ml-10",disabled:!r.monitoringChart,onClick:t[0]||(t[0]=e=>i.monitoringAppRoute())},[(0,o.createTextVNode)((0,o.toDisplayString)(i.monitoringChartLink),1)],8,Y)),[[d,i.monitoringLinkTooltip]])])]),(0,o.createElementVNode)("div",U,[r.outdatedServiceMonitor?((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:0},[(0,o.createElementVNode)("i",{"data-testid":"kw-sm-icon",class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(!r.outdatedServiceMonitor)])},null,2),(0,o.createElementVNode)("div",G,[(0,o.withDirectives)((0,o.createElementVNode)("p",W,null,512),[[p,e.t("kubewarden.monitoring.prerequisites.serviceMonitor.upgrade.label",{},!0)]]),r.kubewardenServiceMonitor&&r.outdatedServiceMonitor?(0,o.withDirectives)(((0,o.openBlock)(),(0,o.createBlock)(l,{key:0,"data-testid":"kw-monitoring-checklist-step-service-monitor-upgrade-button",mode:"serviceMonitorUpgrade",class:"ml-10",disabled:i.updateServiceMonitorButtonDisabled,onClick:i.updateServiceMonitor},null,8,["disabled","onClick"])),[[d,i.updateServiceMonitorsTooltip]]):(0,o.createCommentVNode)("",!0)])],64)):((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:1},[(0,o.createElementVNode)("i",{"data-testid":"kw-sm-icon",class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(r.kubewardenServiceMonitor)])},null,2),(0,o.createElementVNode)("div",z,[(0,o.withDirectives)((0,o.createElementVNode)("p",F,null,512),[[p,e.t("kubewarden.monitoring.prerequisites.serviceMonitor.label",{},!0)]]),r.kubewardenServiceMonitor?(0,o.createCommentVNode)("",!0):(0,o.withDirectives)(((0,o.openBlock)(),(0,o.createBlock)(l,{key:0,"data-testid":"kw-monitoring-checklist-step-service-monitor-button",mode:"serviceMonitor",class:"ml-10",disabled:i.serviceMonitorButtonDisabled,onClick:i.addServiceMonitor},null,8,["disabled","onClick"])),[[d,i.serviceMonitorsTooltip]])])],64))]),(0,o.createElementVNode)("div",Q,[(0,o.createElementVNode)("i",{"data-testid":"kw-dashboard-icon",class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(i.hasKubewardenDashboards)])},null,2),(0,o.createElementVNode)("div",K,[(0,o.withDirectives)((0,o.createElementVNode)("p",H,null,512),[[p,e.t("kubewarden.monitoring.prerequisites.configMap.label",{},!0)]]),i.hasKubewardenDashboards?(0,o.createCommentVNode)("",!0):(0,o.withDirectives)(((0,o.openBlock)(),(0,o.createBlock)(l,{key:0,"data-testid":"kw-monitoring-checklist-step-config-map-button",mode:"grafanaDashboard",class:"ml-10",disabled:i.dashboardButtonDisabled,onClick:i.addDashboards},null,8,["disabled","onClick"])),[[d,i.dashboardsTooltip]])])]),i.showConflictingDashboardsBanner?((0,o.openBlock)(),(0,o.createBlock)(s,{key:0,color:"error"},{default:(0,o.withCtx)((()=>[(0,o.createElementVNode)("div",J,[(0,o.createElementVNode)("p",null,(0,o.toDisplayString)(e.t("kubewarden.monitoring.prerequisites.configMap.conflictingDashboardsBanner",{count:r.conflictingGrafanaDashboards.length},!0)),1),((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(r.conflictingGrafanaDashboards,(e=>((0,o.openBlock)(),(0,o.createBlock)(c,{key:e.metadata.name,to:e.detailLocation,class:"text-bold"},{default:(0,o.withCtx)((()=>[(0,o.createTextVNode)((0,o.toDisplayString)(e.metadata.name),1)])),_:2},1032,["to"])))),128))])])),_:1})):(0,o.createCommentVNode)("",!0),(0,o.createElementVNode)("div",null,[r.outdatedTelemetrySpec?((0,o.openBlock)(),(0,o.createBlock)(s,{key:0,"data-testid":"kw-monitoring-checklist-outdated-telemetry",color:"error",label:e.t("kubewarden.monitoring.prerequisites.outdated")},null,8,["label"])):(0,o.createCommentVNode)("",!0),r.unsupportedTelemetrySpec?((0,o.openBlock)(),(0,o.createBlock)(s,{key:1,"data-testid":"kw-monitoring-checklist-unsupported-telemetry",color:"error",label:e.t("kubewarden.monitoring.prerequisites.unsupported")},null,8,["label"])):(0,o.createCommentVNode)("",!0)]),(0,o.createElementVNode)("div",X,[(0,o.createElementVNode)("i",{"data-testid":"kw-metrics-config-icon",class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(r.metricsConfiguration)])},null,2),(0,o.createElementVNode)("div",Z,[(0,o.withDirectives)((0,o.createElementVNode)("p",ee,null,512),[[p,e.t("kubewarden.monitoring.prerequisites.controllerConfig.label",{},!0)]]),r.metricsConfiguration?(0,o.createCommentVNode)("",!0):(0,o.withDirectives)(((0,o.openBlock)(),(0,o.createElementBlock)("button",{key:0,"data-testid":"kw-monitoring-checklist-step-config-button",class:"btn role-primary ml-10",disabled:i.controllerLinkDisabled,onClick:t[1]||(t[1]=e=>i.controllerAppRoute())},[(0,o.createTextVNode)((0,o.toDisplayString)(e.t("kubewarden.monitoring.prerequisites.controllerConfig.button")),1)],8,te)),[[d,i.controllerLinkTooltip]])])])])])}var oe=r(14220),ae=r(88771),ne={props:{cattleDashboardNs:{type:Object,default:null},conflictingGrafanaDashboards:{type:Array,default:null},controllerApp:{type:Object,default:null},controllerChart:{type:Object,default:null},kubewardenServiceMonitor:{type:Object,default:null},kubewardenDashboards:{type:Array,default:null},metricsConfiguration:{type:Boolean,default:null},monitoringApp:{type:Object,default:null},monitoringChart:{type:Object,default:null},openTelSvc:{type:Object,default:null},policyObj:{type:Object,default:null},policyServerObj:{type:Object,default:null},outdatedTelemetrySpec:{type:Boolean,default:!1},unsupportedTelemetrySpec:{type:Boolean,default:!1},outdatedServiceMonitor:{type:Boolean,default:!1}},components:{AsyncButton:ae.A,Banner:w.l},computed:{...(0,i.L8)(["currentCluster"]),...(0,i.L8)({t:"i18n/t"}),controllerLinkDisabled(){return!this.openTelSvc||!this.monitoringApp||!this.hasKubewardenDashboards||!this.controllerChart||!this.controllerApp},controllerLinkTooltip(){return this.controllerLinkDisabled?this.t("kubewarden.monitoring.prerequisites.tooltips.prerequisites"):this.controllerChart?null:this.t("kubewarden.monitoring.prerequisites.tooltips.chartError",{chart:"Kubewarden Controller"},!0)},dashboardsTooltip(){return this.monitoringApp?this.monitoringApp&&l()(this.cattleDashboardNs)?this.t("kubewarden.monitoring.prerequisites.tooltips.nsNotFound"):null:this.t("kubewarden.monitoring.prerequisites.tooltips.appNotInstalled",{app:"Rancher Monitoring"},!0)},dashboardButtonDisabled(){return!this.monitoringApp||l()(this.cattleDashboardNs)||!this.hasKubewardenDashboards&&!!this.conflictingGrafanaDashboards.length},hasKubewardenDashboards(){return!l()(this.kubewardenDashboards)},monitoringChartLink(){return this.monitoringApp?this.t("kubewarden.monitoring.prerequisites.monitoringApp.edit"):this.t("kubewarden.monitoring.prerequisites.monitoringApp.install")},monitoringLinkTooltip(){return this.monitoringChart?null:this.t("kubewarden.monitoring.prerequisites.tooltips.chartError",{chart:"Rancher Monitoring"},!0)},serviceMonitorButtonDisabled(){return!this.controllerApp||!this.monitoringApp},serviceMonitorsTooltip(){return this.monitoringApp?!this.kubewardenServiceMonitor&&this.controllerApp?this.t("kubewarden.monitoring.prerequisites.tooltips.monitorsNotFound",{namespace:this.controllerApp.metadata?.namespace},!0):null:this.t("kubewarden.monitoring.prerequisites.tooltips.prerequisites")},updateServiceMonitorsTooltip(){return this.t("kubewarden.monitoring.prerequisites.tooltips.updateServiceMonitor",{},!0)},updateServiceMonitorButtonDisabled(){return!this.kubewardenServiceMonitor||!this.monitoringApp},showConflictingDashboardsBanner(){return!this.hasKubewardenDashboards&&!l()(this.conflictingGrafanaDashboards)}},methods:{async addDashboards(e){try{await V({store:this.$store,monitoringApp:this.monitoringApp,controllerApp:this.controllerApp}),e(!0)}catch(t){(0,E.q)({error:t,store:this.$store}),e(!1)}},async addServiceMonitor(e){try{await M({store:this.$store,policyObj:this.policyObj,policyServerObj:this.policyServerObj,controllerNs:this.controllerApp?.metadata?.namespace,serviceMonitor:this.kubewardenServiceMonitor}),this.$emit("updateServiceMonitors"),e(!0)}catch(t){(0,E.q)({error:t,store:this.$store}),e(!1)}},async updateServiceMonitor(e){if(this.kubewardenServiceMonitor)try{const t=this.kubewardenServiceMonitor,r=this.policyServerObj?.metadata?.name||this.policyObj?.spec?.policyServer;t.spec.selector.matchLabels={"app.kubernetes.io/instance":`policy-server-${r}`,"app.kubernetes.io/component":"policy-server","app.kubernetes.io/part-of":"kubewarden"},await t.save(),this.$emit("updateServiceMonitorLabels"),e(!0)}catch(t){(0,E.q)({error:t,store:this.$store}),e(!1)}else e(!1)},badgeIcon(e){if(Array.isArray(e)){const t=l()(e);return{"icon-dot-open":t,"icon-checkmark":!t,"text-success":!t}}return{"icon-dot-open":!e,"icon-checkmark":e,"text-success":e}},monitoringAppRoute(){if(!this.monitoringApp&&this.monitoringChart&&this.monitoringChart.goToInstall(),this.monitoringApp){const e={[oe.CU]:this.monitoringApp.metadata?.namespace,[oe.o_]:this.monitoringApp.metadata?.name,[oe.xv]:this.monitoringApp.spec?.chart?.metadata?.version,[oe.NO]:this.monitoringApp.spec?.chart?.metadata?.annotations?.[h.W8.SOURCE_REPO_NAME],[oe.Eo]:this.monitoringApp.spec?.chart?.metadata?.annotations?.[h.W8.SOURCE_REPO_TYPE],[oe.RX]:this.monitoringApp.spec?.chart?.metadata?.name};this.$router.push({name:"c-cluster-apps-charts-install",params:{cluster:this.currentCluster?.id||"_"},query:e})}},controllerAppRoute(){if(this.controllerApp){const e=this.controllerApp.spec?.chart?.metadata,t={[oe.CU]:e?.annotations?.[h.W8.NAMESPACE],[oe.o_]:e?.annotations?.[h.W8.RELEASE_NAME],[oe.xv]:e?.annotations?.["catalog.cattle.io/upstream-version"],[oe.NO]:e?.annotations?.[h.W8.SOURCE_REPO_NAME],[oe.Eo]:e?.annotations?.[h.W8.SOURCE_REPO_TYPE],[oe.RX]:e?.name};this.$router.push({name:"c-cluster-apps-charts-install",params:{cluster:this.currentCluster?.id||"_"},query:t})}}}},ie=(r(85688),r(47433));const se=(0,ie.A)(ne,[["render",re],["__scopeId","data-v-bc826a2a"]]);var le=se,ce={props:{active:{type:Boolean,default:null},resource:{type:String,default:null},policyObj:{type:Object,default:null},policyServerObj:{type:Object,default:null}},components:{Banner:w.l,DashboardMetrics:k.A,Loading:f.A,MetricsChecklist:le},mixins:[g.A],async fetch(){await this.fetchData()},data(){const e=this.resource===S.$v.POLICY_SERVER?S.YR.POLICY_SERVER:S.YR.POLICY;return{METRICS_TYPE:e,isAdminUser:!1,permissions:{policyServer:!1,app:!1,clusterRepo:!1,configMap:!1,serviceMonitor:!1,namespace:!1,service:!1},[m.W8.APP]:null,[m.W8.CLUSTER_REPO]:null,[m.K5]:null,[m.Rp.SERVICEMONITOR]:null,[m.YV]:null,metricsProxy:null,metricsService:null,debouncedRefreshCharts:null,outdatedTelemetrySpec:!1,unsupportedTelemetrySpec:!1}},watch:{async grafanaService(){this.metricsProxy||(this.metricsProxy=await N({store:this.$store,type:this.METRICS_TYPE}),this.metricsProxy&&(this.metricsService=await(0,b.no)("v2",this.$store,this.currentCluster?.id,this.metricsProxy)))}},computed:{...(0,i.L8)(["currentCluster","productId"]),...(0,i.L8)({charts:"catalog/charts"}),...(0,y.dO)(),policyName(){return(0,B.OJ)(this.policyObj)},allApps(){return this.$store.getters["cluster/all"](m.W8.APP)},allRepos(){return this.$store.getters["cluster/all"](m.W8.CLUSTER_REPO)},allConfigMaps(){return this.$store.getters["cluster/all"](m.K5)},allNamespaces(){return this.$store.getters["cluster/all"](m.CU)},allPolicyServers(){return this.$store.getters["cluster/all"](S.$v.POLICY_SERVER)},allServiceMonitors(){return this.$store.getters["cluster/all"](m.Rp.SERVICEMONITOR)},allServices(){return this.$store.getters["cluster/all"](m.YV)},cattleDashboardNs(){return this.allNamespaces?.find((e=>"cattle-dashboards"===e?.metadata?.name))},conflictingGrafanaDashboards(){return this.allConfigMaps?.filter((e=>{const t=e?.metadata?.name;if(t)return t===S.YR.POLICY_SERVER||t===S.YR.POLICY}))},controllerApp(){return this.allApps?.find((e=>e?.spec?.chart?.metadata?.name===S.j6.CONTROLLER))},controllerChart(){return this.charts?.find((e=>e.chartName===S.j6.CONTROLLER))},grafanaService(){const e=this.allServices?.filter((e=>"rancher-monitoring"===e?.metadata?.labels?.["app.kubernetes.io/instance"]));return e?.find((e=>"grafana"===e?.metadata?.labels?.["app.kubernetes.io/name"]))},hasAvailability(){return this.isAdminUser||Object.values(this.permissions).every((e=>e))},kubewardenGrafanaDashboards(){return this.allConfigMaps?.filter((e=>e?.metadata?.labels?.[S.kl.DASHBOARD]))},kubewardenServiceMonitor(){return P({policyObj:this.policyObj,policyServerObj:this.policyServerObj,controllerNs:this.controllerApp?.metadata?.namespace,allServiceMonitors:this.allServiceMonitors})},metricsConfiguration(){if(!this.controllerApp?.values)return null;const e=this.controllerApp?.spec?.chart?.metadata?.version,t=this.controllerApp?.values?.telemetry;if(u().gte(e,"4.0.0-0")){const e=void 0===t?.metrics||"boolean"===typeof t?.metrics;return"custom"===t?.mode?(this.handleMetricsChecklist("unsupportedTelemetrySpec",!0),null):e?!0!==t?.metrics?null:t?.metrics:(this.handleMetricsChecklist("outdatedTelemetrySpec",!0),null)}return t?.metrics?.enabled},monitoringApp(){return this.allApps?.find((e=>"rancher-monitoring"===e?.spec?.chart?.metadata?.name))},monitoringChart(){return this.charts?.find((e=>"rancher-monitoring"===e.chartName))},outdatedServiceMonitor(){const e=this.kubewardenServiceMonitor,t=this.policyServerObj;return!(!e||!t)&&O(t,e)},openTelemetryServices(){return this.allServices?this.allServices.filter((e=>"opentelemetry-operator"===e?.metadata?.labels?.[h.pS.MANAGED_NAME])):null},openTelSvc(){return l()(this.openTelemetryServices)?null:this.openTelemetryServices.find((e=>{const t=e?.spec?.ports;if(t.length)return t.find((e=>8080===e.port))}))},policyServerSvcs(){if(!l()(this.allPolicyServers)){const e=this.allPolicyServers.map((e=>e?.metadata?.name)).filter(Boolean),t=e.map((e=>(0,_.LY)(this.allServices,e)));return t}return null},showChecklist(){const e=[!this.openTelSvc,!this.monitoringApp,!this.kubewardenServiceMonitor,!this.metricsConfiguration,!this.kubewardenGrafanaDashboards||l()(this.kubewardenGrafanaDashboards),this.outdatedServiceMonitor];return e.some(Boolean)}},methods:{async fetchData(){this.setAdminUser(),this.setPermissions(),this.initDebouncedRefreshCharts(),await this.fetchResourcesData(),this.refreshChartsIfNeeded(),await this.handleGrafanaDashboard(),await this.fetchControllerAppValues()},setAdminUser(){this.isAdminUser=(0,C.X)(this.$store.getters)},setPermissions(){const e={policyServer:{type:S.$v.POLICY_SERVER},app:{type:m.W8.APP},clusterRepo:{type:m.W8.CLUSTER_REPO},configMap:{type:m.K5},serviceMonitor:{type:m.Rp.SERVICEMONITOR},namespace:{type:m.CU},service:{type:m.YV}};Object.entries(e).forEach((([e,t])=>{this.$store.getters["cluster/canList"](t)&&(this.permissions[e]=!0)}))},initDebouncedRefreshCharts(){this.debouncedRefreshCharts=p()(((e=!1)=>{(0,A.Xj)({store:this.$store,chartName:"rancher-monitoring",init:e})}),500)},async fetchResourcesData(){const e=[{name:m.W8.APP,property:this.allApps},{name:m.W8.CLUSTER_REPO,property:this.allRepos},{name:m.K5,property:this.allConfigMaps},{name:S.$v.POLICY_SERVER,property:this.allPolicyServers},{name:m.Rp.SERVICEMONITOR,property:this.allServiceMonitors},{name:m.CU,property:this.allNamespaces},{name:m.YV,property:this.allServices}],t=e.reduce(((e,t)=>(l()(t.property)&&this.$store.getters["cluster/canList"](t.name)&&e.push(this.$fetchType(t.name)),e)),[]);await(0,v.kR)(t)},refreshChartsIfNeeded(){this.showChecklist&&!this.monitoringChart&&this.debouncedRefreshCharts(!0)},async handleGrafanaDashboard(){if(this.monitoringStatus.installed)try{this.metricsProxy=await N({store:this.$store,type:this.METRICS_TYPE}),this.metricsProxy&&(this.metricsService=await(0,b.no)("v2",this.$store,this.currentCluster?.id,this.metricsProxy))}catch(e){(0,E.q)({error:{_statusText:"Error",message:`Error fetching Grafana Service: ${e}`},store:this.$store})}},async fetchControllerAppValues(){this.controllerApp&&await this.controllerApp.fetchValues(!0)},async updateServiceMonitors(){await this.$fetchType(m.Rp.SERVICEMONITOR)},async updateServiceMonitorLabels(){await this.$fetchType(m.Rp.SERVICEMONITOR),this.outdatedServiceMonitor=!1},handleMetricsChecklist(e,t){this[e]=t}}};const pe=(0,ie.A)(ce,[["render",n]]);var de=pe},74947:function(e,t,r){"use strict";r.d(t,{OJ:function(){return p},lq:function(){return c}});var o=r(3514),a=r.n(o),n=r(56505);function i(e,t){const r=e?.links["view"],o=r.lastIndexOf("/");return s(r.slice(0,o),"http",e?.metadata.name,t)}function s(e,t,r,o,a){const n=(t?`${encodeURIComponent(t)}:`:"")+encodeURIComponent(r)+(o?`:${encodeURIComponent(o)}`:""),i=`/${(a||"").replace(/^\/+/g,"")}`,s=e.replace(/\/+$/g,""),l=`${s}/${n}/proxy${i}`;return l}var l=r(4364);async function c(e){const{store:t,queryService:r,resource:o,relatedPolicies:n,policy:s,time:c}=e;try{const e=i(r,16686),l=[];if(a()(n)){if(!s)throw new Error("Policy is undefined");l.push(d(t,e,s,c))}else n?.forEach((r=>{const o=d(t,e,r,c);o&&l.push(o)}));let p=await Promise.all(l);return p=p.flatMap((e=>e?.data)),u(t,p,o,n,s)}catch(p){l.warn(`Error fetching Jaeger traces: ${p}`)}return null}function p(e){let t=null;switch(e?.kind){case"ClusterAdmissionPolicy":t=`clusterwide-${e?.metadata?.name}`;break;case"AdmissionPolicy":t=`namespaced-${e?.metadata?.namespace}-${e?.metadata?.name}`;break;default:break}return t}function d(e,t,r,o){let a=null;const n=p(r),i=o||"2d",s=`lookback=${i}&tags={"policy_id"%3A"${n}"}`;a=`api/traces?service=kubewarden-policy-server&operation=validation&${s}`;const l=`${t+a}`;return e.dispatch("cluster/request",{url:l})}function u(e,t,r,o,i){const s=e.getters["currentCluster"],l=[];function c(r){const o=p(r);return t.reduce(((t,n)=>{let i={};const l=n.spans.find((e=>"validation"===e.operationName)),c=l?.tags?.find((e=>"policy_id"===e?.key&&e?.value===o));if(c){const e=m(l.tags);i={id:n.traceID,allowed:e.allowed,mode:r.spec.mode,name:e.name,operation:e.operation,kind:e.kind,namespace:e.namespace||null,startTime:l.startTime,duration:l.duration,responseMessage:e.response_message,responseCode:e.response_code,mutated:e.mutated}}return a()(i)||(t.push(i),e.dispatch("kubewarden/updatePolicyTraces",{policyName:r.metadata.name,cluster:s?.id,updatedTrace:i})),t}),[])}if(r===n.$v.POLICY_SERVER)for(const n of o){const e=c(n);a()(e)||l.push({policyName:n.metadata.name,cluster:s?.id,traces:e})}else{const e=c(i);a()(e)||l.push({policyName:i.metadata.name,cluster:s?.id,traces:e})}return l}function m(e){const t={};for(const r of e)switch(r.type){case"string":t[r.key]=r.value;break;case"int64":t[r.key]=parseInt(r.value,10);break;case"float64":t[r.key]=parseFloat(r.value);break;case"bool":t[r.key]="true"===r.value;break;default:t[r.key]=r.value}return t}},82142:function(e,t,r){var o=r(99678);o.__esModule&&(o=o.default),"string"===typeof o&&(o=[[e.id,o,""]]),o.locals&&(e.exports=o.locals);var a=r(74825).A;a("29f75efb",o,!0,{sourceMap:!1,shadowMode:!1})},85688:function(e,t,r){var o=r(95480);o.__esModule&&(o=o.default),"string"===typeof o&&(o=[[e.id,o,""]]),o.locals&&(e.exports=o.locals);var a=r(74825).A;a("b7c178a2",o,!0,{sourceMap:!1,shadowMode:!1})},91226:function(e,t,r){var o=r(13914);o.__esModule&&(o=o.default),"string"===typeof o&&(o=[[e.id,o,""]]),o.locals&&(e.exports=o.locals);var a=r(74825).A;a("587c4bcd",o,!0,{sourceMap:!1,shadowMode:!1})},95480:function(e,t,r){"use strict";r.r(t);var o=r(36758),a=r.n(o),n=r(40935),i=r.n(n),s=i()(a());s.push([e.id,".checklist__container[data-v-bc826a2a]{display:flex;justify-content:center;flex-direction:column;border:1px solid var(--border);padding:10px}.checklist__config[data-v-bc826a2a],.checklist__step[data-v-bc826a2a]{display:flex;flex-direction:row;justify-content:flex-start;align-items:center}.checklist__step[data-v-bc826a2a]{min-height:40px}.conflicting-banner[data-v-bc826a2a]{display:flex;flex-direction:column}",""]),t["default"]=s},96003:function(e,t,r){"use strict";r.d(t,{A:function(){return ue}});var o=r(9274);const a={key:1},n={class:"text-bold"},i=["colspan"],s={class:"details"},l={class:"col"},c={class:"text-info text-capitalize"},p={class:"col"},d={class:"text-info"},u={class:"col"},m={class:"text-info"};function h(e,t,r,h,b,y){const v=(0,o.resolveComponent)("Loading"),g=(0,o.resolveComponent)("Banner"),k=(0,o.resolveComponent)("TraceChecklist"),f=(0,o.resolveComponent)("BadgeState"),w=(0,o.resolveComponent)("SortableTable");return e.$fetchState.pending||e.refreshingCharts?((0,o.openBlock)(),(0,o.createBlock)(v,{key:0,mode:"relative"})):((0,o.openBlock)(),(0,o.createElementBlock)("div",a,[y.hasAvailability?y.showChecklist?((0,o.openBlock)(),(0,o.createBlock)(k,{key:1,"controller-app":y.controllerApp,"controller-chart":y.controllerChart,"tracing-configuration":y.tracingConfiguration,"jaeger-query-svc":y.jaegerQuerySvc,"open-tel-svc":y.openTelSvc,"outdated-telemetry-spec":b.outdatedTelemetrySpec,"unsupported-telemetry-spec":b.unsupportedTelemetrySpec,"incomplete-telemetry-spec":b.incompleteTelemetrySpec},null,8,["controller-app","controller-chart","tracing-configuration","jaeger-query-svc","open-tel-svc","outdated-telemetry-spec","unsupported-telemetry-spec","incomplete-telemetry-spec"])):!y.showChecklist&&y.emptyPolicies?((0,o.openBlock)(),(0,o.createBlock)(g,{key:2,color:"error",label:e.t("kubewarden.tracing.noRelatedPolicies")},null,8,["label"])):y.showTable?((0,o.openBlock)(),(0,o.createBlock)(w,{key:3,rows:y.filteredValidations,headers:b.TRACE_HEADERS,"table-actions":!1,"row-actions":!1,"key-field":"id","default-sort-by":"startTime","sub-expandable":!0,"sub-expand-column":!0,"sub-rows":!0,paging:!0,"rows-per-page":y.rowsPerPage},{"col:mode":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,[(0,o.createVNode)(f,{label:e.mode,color:y.modeColor(e.mode),class:"text-capitalize"},null,8,["label","color"])])])),"col:name":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",n,(0,o.toDisplayString)(e.name),1)])),"col:namespace":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,(0,o.toDisplayString)(e.namespace?e.namespace:"-"),1)])),"col:startTime":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,(0,o.toDisplayString)(y.formatTime(e.startTime)),1)])),"col:duration":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,(0,o.toDisplayString)(y.duration(e.duration)),1)])),"sub-row":(0,o.withCtx)((({row:e,fullColspan:r})=>[(0,o.createElementVNode)("td",{colspan:r,class:"sub-row"},[(0,o.createElementVNode)("div",s,[(0,o.createElementVNode)("section",l,[t[0]||(t[0]=(0,o.createElementVNode)("div",{class:"title"},"Response Message",-1)),(0,o.createElementVNode)("span",c,(0,o.toDisplayString)(e.responseMessage?e.responseMessage:"-"),1)]),(0,o.createElementVNode)("section",p,[t[1]||(t[1]=(0,o.createElementVNode)("div",{class:"title"},"Response Code",-1)),(0,o.createElementVNode)("span",d,(0,o.toDisplayString)(e.responseCode?e.responseCode:"-"),1)]),(0,o.createElementVNode)("section",u,[t[2]||(t[2]=(0,o.createElementVNode)("div",{class:"title"},"Mutated",-1)),(0,o.createElementVNode)("span",m,(0,o.toDisplayString)(e.mutated),1)])])],8,i)])),_:1},8,["rows","headers","rows-per-page"])):((0,o.openBlock)(),(0,o.createBlock)(g,{key:4,color:"warning",label:e.t(y.emptyTracesLabel)},null,8,["label"])):((0,o.openBlock)(),(0,o.createBlock)(g,{key:0,color:"error",class:"mt-20 mb-20","data-testid":"kw-unavailability-banner",label:e.t("kubewarden.unavailability.banner",{type:e.t("kubewarden.unavailability.type.tracingDashboard")})},null,8,["label"]))]))}var b=r(65359),y=r(3514),v=r.n(y),g=r(2722),k=r.n(g),f=r(23464),w=r.n(f),S=r(25562),C=r.n(S),E=r(35664),A=r(2841),N=r(72586),R=r(88339),T=r(87102),V=r(9980),_=r(84409),P=r(82964),M=r(65165),O=r(56505),B=r(74947),D=r(65921),j=r(99241),x=r.n(j),L=r(119),$=r.n(L),I=r(10279),q=r.n(I);w().extend(q());const Y=1e3,U=1e3*Y,G=60*U,W=60*G,z=24*W,F=[{unit:"d",microseconds:z,ofPrevious:24},{unit:"h",microseconds:W,ofPrevious:60},{unit:"m",microseconds:G,ofPrevious:60},{unit:"s",microseconds:U,ofPrevious:1e3},{unit:"ms",microseconds:Y,ofPrevious:1e3},{unit:"μs",microseconds:1,ofPrevious:1e3}];function Q(e){const[t,r]=x()(F,(({microseconds:t},r)=>r<F.length-1&&t>e));if(1e3===t.ofPrevious)return`${$()(e/t.microseconds,2)}${t.unit}`;const o=Math.floor(e/t.microseconds),a=`${o}${t.unit}`,n=Math.round(e/r.microseconds%t.ofPrevious),i=`${n}${r.unit}`;return 0===n?a:`${a} ${i}`}const K={class:"checklist__description mb-20","data-testid":"kw-tracing-checklist-description"},H={class:"checklist__prereq mb-20"},J={class:"checklist__container mt-20 mb-20"},X={class:"checklist__step mb-20","data-testid":"kw-tracing-checklist-step-open-tel"},Z={class:"checklist__step mb-20","data-testid":"kw-tracing-checklist-step-jaeger"},ee={p:""},te={class:"checklist__step mb-20","data-testid":"kw-tracing-checklist-step-config"},re={class:"checklist__config"},oe=["disabled"];function ae(e,t,r,a,n,i){const s=(0,o.resolveComponent)("Banner"),l=(0,o.resolveDirective)("clean-html"),c=(0,o.resolveDirective)("clean-tooltip");return(0,o.openBlock)(),(0,o.createElementBlock)("div",null,[(0,o.createElementVNode)("p",K,(0,o.toDisplayString)(e.t("kubewarden.tracing.description")),1),(0,o.createElementVNode)("div",H,[(0,o.createElementVNode)("h2",null,(0,o.toDisplayString)(e.t("kubewarden.tracing.prerequisites.label")),1),(0,o.createElementVNode)("p",null,(0,o.toDisplayString)(e.t("kubewarden.tracing.prerequisites.description")),1)]),(0,o.createVNode)(s,{color:"warning",label:e.t("kubewarden.tracing.prerequisites.warning")},null,8,["label"]),(0,o.createElementVNode)("div",J,[(0,o.createElementVNode)("div",X,[(0,o.createElementVNode)("i",{class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(r.openTelSvc)])},null,2),(0,o.withDirectives)((0,o.createElementVNode)("p",null,null,512),[[l,e.t("kubewarden.tracing.openTelemetry",{},!0)]])]),(0,o.createElementVNode)("div",Z,[(0,o.createElementVNode)("i",{class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(r.jaegerQuerySvc)])},null,2),(0,o.withDirectives)((0,o.createElementVNode)("p",ee,null,512),[[l,e.t("kubewarden.tracing.jaeger",{},!0)]])]),(0,o.createElementVNode)("div",null,[r.outdatedTelemetrySpec?((0,o.openBlock)(),(0,o.createBlock)(s,{key:0,color:"error",label:e.t("kubewarden.tracing.prerequisites.outdated")},null,8,["label"])):(0,o.createCommentVNode)("",!0),r.unsupportedTelemetrySpec?((0,o.openBlock)(),(0,o.createBlock)(s,{key:1,color:"error",label:e.t("kubewarden.tracing.prerequisites.unsupported")},null,8,["label"])):(0,o.createCommentVNode)("",!0),r.incompleteTelemetrySpec?((0,o.openBlock)(),(0,o.createBlock)(s,{key:2,color:"error",label:e.t("kubewarden.tracing.prerequisites.incomplete")},null,8,["label"])):(0,o.createCommentVNode)("",!0)]),(0,o.createElementVNode)("div",te,[(0,o.createElementVNode)("i",{class:(0,o.normalizeClass)(["icon mr-10",i.badgeIcon(i.tracingEnabled)])},null,2),(0,o.createElementVNode)("div",re,[(0,o.withDirectives)((0,o.createElementVNode)("p",null,null,512),[[l,e.t("kubewarden.tracing.config.label",{},!0)]]),(0,o.withDirectives)(((0,o.openBlock)(),(0,o.createElementBlock)("button",{"data-testid":"kw-tracing-checklist-step-config-button",class:"btn role-primary ml-10",disabled:i.controllerLinkDisabled,onClick:t[0]||(t[0]=(...e)=>i.controllerAppRoute&&i.controllerAppRoute(...e))},[(0,o.createTextVNode)((0,o.toDisplayString)(e.t("kubewarden.tracing.config.link")),1)],8,oe)),[[c,i.controllerLinkTooltip]])])])])])}var ne=r(14220),ie={props:{controllerApp:{type:Object,default:null},controllerChart:{type:Object,default:null},tracingConfiguration:{type:Object,default:null},jaegerQuerySvc:{type:Object,default:null},openTelSvc:{type:Object,default:null},outdatedTelemetrySpec:{type:Boolean,default:!1},unsupportedTelemetrySpec:{type:Boolean,default:!1},incompleteTelemetrySpec:{type:Boolean,default:!1}},components:{Banner:V.l},computed:{...(0,b.L8)(["currentCluster"]),controllerLinkTooltip(){return this.openTelSvc&&this.jaegerQuerySvc?this.controllerApp&&this.controllerChart?null:this.t("kubewarden.monitoring.prerequisites.tooltips.chartError",{chart:"Kubewarden Controller"},!0):this.t("kubewarden.monitoring.prerequisites.tooltips.prerequisites")},controllerLinkDisabled(){return!this.openTelSvc||!this.jaegerQuerySvc||!this.controllerApp||!this.controllerChart},tracingEnabled(){return this.tracingConfiguration?this.tracingConfiguration.enabled:null}},methods:{badgeIcon(e){return{"icon-dot-open":!e,"icon-checkmark":e,"text-success":e}},controllerAppRoute(){if(this.controllerApp){const e=this.controllerApp.spec?.chart?.metadata,t={[ne.CU]:e?.annotations?.[A.W8.NAMESPACE],[ne.o_]:e?.annotations?.[A.W8.RELEASE_NAME],[ne.xv]:e?.annotations?.["catalog.cattle.io/upstream-version"],[ne.NO]:e?.annotations?.[A.W8.SOURCE_REPO_NAME],[ne.Eo]:e?.annotations?.[A.W8.SOURCE_REPO_TYPE],[ne.RX]:e?.name};this.$router.push({name:"c-cluster-apps-charts-install",params:{cluster:this.currentCluster?.id||"_"},query:t})}}}},se=(r(82142),r(47433));const le=(0,se.A)(ie,[["render",ae],["__scopeId","data-v-7139a8b0"]]);var ce=le;w().extend(C());var pe={props:{resource:{type:String,default:()=>""},relatedPolicies:{type:Array,default:()=>[]},policy:{type:Object,default:()=>{}}},components:{BadgeState:T.j,Banner:V.l,Loading:_.A,SortableTable:P.A,TraceChecklist:ce},mixins:[N.A],async fetch(){await this.fetchData()},data(){return{MODE_MAP:O.lN,TRACE_HEADERS:M.Tc,OPERATION_MAP:O.bq,isAdminUser:!1,permissions:{policyServer:!1,app:!1,clusterRepo:!1,service:!1},specificValidations:null,outdatedTelemetrySpec:!1,unsupportedTelemetrySpec:!1,incompleteTelemetrySpec:!1}},computed:{...(0,b.L8)(["currentCluster"]),...(0,b.L8)({charts:"catalog/charts",refreshingCharts:"kubewarden/refreshingCharts"}),allApps(){return this.$store.getters["cluster/all"](E.W8.APP)},allServices(){return this.$store.getters["cluster/all"](E.YV)},controllerApp(){return this.allApps?.find((e=>e?.spec?.chart?.metadata?.name===O.j6.CONTROLLER))},controllerChart(){return this.charts?.find((e=>e?.chartName===O.j6.CONTROLLER))},groupField(){return this.isPolicyServer?"policy_id":null},isPolicyServer(){return this.resource===O.$v.POLICY_SERVER},emptyPolicies(){return this.resource===O.$v.POLICY_SERVER?v()(this.relatedPolicies):v()(this.policy)},emptyTraces(){return v()(this.filteredValidations)},emptyTracesLabel(){return this.resource===O.$v.POLICY_SERVER?"kubewarden.tracing.noRelatedTraces":"kubewarden.tracing.noTraces"},hasAvailability(){return this.isAdminUser||Object.values(this.permissions).every((e=>e))},rowsPerPage(){return this.isPolicyServer?40:20},tracingConfiguration(){if(!this.controllerApp?.values)return null;const e=this.controllerApp?.spec?.chart?.metadata?.version,t=this.controllerApp?.values?.telemetry;if(k().gte(e,"4.0.0-0")){const e=void 0===t?.tracing||"boolean"===typeof t?.tracing,r=!!t?.sidecar?.tracing?.jaeger?.endpoint;return"custom"===t?.mode?(this.handleTracingChecklist("unsupportedTelemetrySpec",!0),null):e?!0!==t?.tracing||r?!0!==t?.tracing?null:t?.sidecar?.tracing:(this.handleTracingChecklist("incompleteTelemetrySpec",!0),null):(this.handleTracingChecklist("outdatedTelemetrySpec",!0),null)}return t?.tracing?.enabled},jaegerServices(){return this.allServices?.filter((e=>"jaeger"===e?.metadata?.labels?.["app.kubernetes.io/part-of"]))},jaegerQuerySvc(){return v()(this.jaegerServices)?null:this.jaegerServices.find((e=>{const t=e?.spec?.ports;if(t.length)return t.find((e=>16685===e.port||16686===e.port))}))},openTelemetryServices(){return this.allServices?.filter((e=>"opentelemetry-operator"===e?.metadata?.labels?.[A.pS.MANAGED_NAME]))},openTelSvc(){return v()(this.openTelemetryServices)?null:this.openTelemetryServices.find((e=>{const t=e?.spec?.ports;if(t.length)return t.find((e=>8080===e.port))}))},showChecklist(){return!this.openTelSvc||!this.jaegerQuerySvc||!this.tracingConfiguration},showTable(){return!this.emptyPolicies&&!this.showChecklist&&!this.emptyTraces},filteredValidations(){return v()(this.specificValidations)?[]:this.specificValidations.flatMap((e=>this.currentCluster?.id===e.cluster?e.traces:[]))}},methods:{async fetchData(){this.setAdminUser(),this.setPermissions(),await this.fetchCanListResources(),await this.handleJaegerTracing(),await this.fetchControllerAppValues()},setAdminUser(){this.isAdminUser=(0,D.X)(this.$store.getters)},setPermissions(){const e={policyServer:{type:O.$v.POLICY_SERVER},app:{type:E.W8.APP},clusterRepo:{type:E.W8.CLUSTER_REPO},service:{type:E.YV}};Object.entries(e).forEach((([e,t])=>{this.$store.getters["cluster/canList"](t)&&(this.permissions[e]=!0)}))},async fetchCanListResources(){const e=[E.W8.APP,E.W8.CLUSTER_REPO,E.YV],t=[];e.forEach((e=>{this.$store.getters["cluster/canList"](e)&&t.push(this.$fetchType(e))})),await(0,R.kR)(t)},async handleJaegerTracing(){if(this.jaegerQuerySvc){const e={store:this.$store,queryService:this.jaegerQuerySvc,resource:this.resource,relatedPolicies:null,policy:null};this.resource===O.$v.POLICY_SERVER?e.relatedPolicies=this.relatedPolicies:e.policy=this.policy,this.specificValidations=await(0,B.lq)(e)}},async fetchControllerAppValues(){this.controllerApp&&await this.controllerApp.fetchValues(!0)},modeColor(e){return this.MODE_MAP[e]},opColor(e){return this.OPERATION_MAP[e]},formatTime(e){return w()(e/1e3)},duration(e){return Q(e)},handleTracingChecklist(e,t){this[e]=t}}};const de=(0,se.A)(pe,[["render",h]]);var ue=de},98618:function(e,t,r){"use strict";r.d(t,{A:function(){return _}});var o=r(9274);const a={class:"mb-20"};function n(e,t,r,n,i,s){const l=(0,o.resolveComponent)("Markdown"),c=(0,o.resolveComponent)("Tab"),p=(0,o.resolveComponent)("RulesTable"),d=(0,o.resolveComponent)("TraceTable"),u=(0,o.resolveComponent)("MetricsTab"),m=(0,o.resolveComponent)("ResourceTabs");return(0,o.openBlock)(),(0,o.createElementBlock)("div",null,[(0,o.createElementVNode)("div",a,[(0,o.createElementVNode)("h3",null,(0,o.toDisplayString)(e.t("namespace.resources")),1)]),(0,o.createVNode)(m,{value:r.value,"data-testid":"kw-policy-detail-tabs",mode:r.mode,"need-related":s.hasRelationships},{default:(0,o.withCtx)((()=>[i.policyReadme?((0,o.openBlock)(),(0,o.createBlock)(c,{key:0,name:"policy-readme",label:"Readme",weight:99},{default:(0,o.withCtx)((()=>[(0,o.createVNode)(l,{value:i.policyReadme,"onUpdate:value":t[0]||(t[0]=e=>i.policyReadme=e),"data-testid":"kw-policy-detail-readme"},null,8,["value"])])),_:1})):(0,o.createCommentVNode)("",!0),s.hasRules?((0,o.openBlock)(),(0,o.createBlock)(c,{key:1,name:"policy-rules",label:"Rules",weight:98},{default:(0,o.withCtx)((()=>[(0,o.createVNode)(p,{rows:s.rulesRows,"data-testid":"kw-policy-detail-rules-table"},null,8,["rows"])])),_:1})):(0,o.createCommentVNode)("",!0),(0,o.createVNode)(c,{name:"policy-tracing",label:"Tracing",weight:97},{default:(0,o.withCtx)((()=>[(0,o.createVNode)(d,{resource:r.resource,policy:r.value,"data-testid":"kw-policy-detail-trace-table"},null,8,["resource","policy"])])),_:1}),(0,o.createVNode)(c,{name:"policy-metrics",label:"Metrics",weight:96},{default:(0,o.withCtx)((e=>[(0,o.createVNode)(u,{resource:r.resource,"policy-obj":r.value,active:e.active},null,8,["resource","policy-obj","active"])])),_:1})])),_:1},8,["value","mode","need-related"])])}var i=r(65359),s=r(3514),l=r.n(s),c=r(14220),p=r(83416),d=r(91825),u=r(36158),m=r(6603),h=r(49584),b=r(56505),y=r(30669);const v={key:1};function g(e,t,r,a,n,i){const s=(0,o.resolveComponent)("SortableTable"),l=(0,o.resolveComponent)("Banner");return(0,o.openBlock)(),(0,o.createElementBlock)("div",null,[r.rows.length>0?((0,o.openBlock)(),(0,o.createBlock)(s,{key:0,"data-testid":"kw-policy-rules-sortable-table",rows:r.rows,headers:n.RULE_HEADERS,"table-actions":!1,"row-actions":!1,"key-field":"traceID","default-sort-by":"startTime"},{"col:apiGroup":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,[(0,o.createElementVNode)("span",null,(0,o.toDisplayString)(e.apiGroups||"-"),1)])])),"col:apiVersion":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,[(0,o.createElementVNode)("span",null,(0,o.toDisplayString)(e.apiVersions||"-"),1)])])),"col:operations":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,[(0,o.createElementVNode)("span",null,(0,o.toDisplayString)(i.joinColumn(e.operations)),1)])])),"col:resources":(0,o.withCtx)((({row:e})=>[(0,o.createElementVNode)("td",null,[(0,o.createElementVNode)("span",null,(0,o.toDisplayString)(i.joinColumn(e.resources)),1)])])),_:1},8,["rows","headers"])):((0,o.openBlock)(),(0,o.createElementBlock)("div",v,[(0,o.createVNode)(l,{class:"type-banner mb-20 mt-0",color:"warning",label:e.t("kubewarden.policies.noRules")},null,8,["label"])]))])}var k=r(9980),f=r(82964),w=r(65165),S={props:{rows:{type:Array,default:()=>[]}},components:{Banner:k.l,SortableTable:f.A},data(){return{RULE_HEADERS:w.e1}},methods:{joinColumn(e){return e?.join(", ")||""}}},C=r(47433);const E=(0,C.A)(S,[["render",g]]);var A=E,N=r(96003),R=r(4364),T={name:"PolicyDetail",components:{Markdown:u.A,MetricsTab:y.A,ResourceTabs:m.A,RulesTable:A,Tab:h.A,TraceTable:N.A},mixins:[d.A],props:{mode:{type:String,default:c.YQ},resource:{type:String,default:null},value:{type:Object,default:()=>{}}},async mounted(){if(this.value?.metadata?.annotations?.[b.zb])try{const e=await this.value.artifactHubPackageVersion();e&&!e.error&&e.readme&&(this.policyReadme=JSON.parse(JSON.stringify(e.readme)))}catch(e){R.warn(`Unable to fetch artifacthub package: ${e}`)}},data(){return{policyReadme:null}},computed:{...(0,i.L8)(["currentCluster"]),...(0,p.dO)(),dashboardVars(){return{policy_name:`clusterwide-${this.value?.id}`}},hasRelationships(){return!!this.value?.metadata?.relationships},hasRules(){return!l()(this.rulesRows?.[0])},rulesRows(){return this.value?.spec?.rules}}};const V=(0,C.A)(T,[["render",n]]);var _=V},99678:function(e,t,r){"use strict";r.r(t);var o=r(36758),a=r.n(o),n=r(40935),i=r.n(n),s=i()(a());s.push([e.id,".checklist__container[data-v-7139a8b0]{display:flex;justify-content:center;flex-direction:column;border:1px solid var(--border);padding:10px}.checklist__config[data-v-7139a8b0],.checklist__step[data-v-7139a8b0]{display:flex;flex-direction:row;justify-content:flex-start;align-items:center}.checklist__step[data-v-7139a8b0]{min-height:40px}",""]),t["default"]=s}}]);
//# sourceMappingURL=kubewarden-4.0.1.umd.min.detail.js.map